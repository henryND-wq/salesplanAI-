<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銷售團隊數據看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            // Data States
            const [salesData, setSalesData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            
            // Dropdown States
            const [selectedBrand, setSelectedBrand] = useState("All");
            const [selectedCenter, setSelectedCenter] = useState("All");
            const [selectedTherapist, setSelectedTherapist] = useState("All");

            // --- FETCH DATA FROM GOOGLE SHEETS ---
            useEffect(() => {
                const sheetId = '1p8cqGBYiqhWgQsDndMjeGwcnupqp6h6tIyCQb1i5LQc';
                const gid = '184945526';
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

                Papa.parse(csvUrl, {
                    download: true,
                    header: false,
                    complete: (results) => {
                        const rows = results.data.slice(1); // Skip the header row
                        
                        // Helper function to safely parse numbers with commas or $ signs
                        const parseNum = (val) => {
                            if (!val) return 0;
                            const cleanVal = String(val).replace(/[$,%]/g, '').trim();
                            return Number(cleanVal) || 0;
                        };

                        const parsedData = rows
                            .filter(row => row[2]) // Ensure Column C (Therapist) is not empty
                            .map(row => ({
                                brand: row[0] ? row[0].trim() : "Unknown",     // Col A
                                center: row[1] ? row[1].trim() : "Unknown",    // Col B
                                therapist: row[2].trim(),                      // Col C
                                target: parseNum(row[3]),                      // Col D
                                actual: parseNum(row[4]),                      // Col E
                                // We skip parsing Col F directly because we will calculate it dynamically for accuracy
                                acb: parseNum(row[6]),                         // Col G
                                icb: parseNum(row[7]),                         // Col H
                                acbShop: parseNum(row[8]),                     // Col I
                                icbShop: parseNum(row[9]),                     // Col J
                            }));
                        
                        setSalesData(parsedData);
                        setIsLoading(false);
                    },
                    error: (error) => {
                        console.error("Error fetching Google Sheet:", error);
                        setIsLoading(false);
                    }
                });
            }, []);

            // --- FILTER LOGIC (Cascading Dropdowns) ---
            const brands = useMemo(() => ["All", ...new Set(salesData.map(d => d.brand))].sort(), [salesData]);
            
            const centers = useMemo(() => {
                const filtered = salesData.filter(d => selectedBrand === "All" || d.brand === selectedBrand);
                return ["All", ...new Set(filtered.map(d => d.center))].sort();
            }, [salesData, selectedBrand]);

            const therapists = useMemo(() => {
                const filtered = salesData.filter(d => 
                    (selectedBrand === "All" || d.brand === selectedBrand) &&
                    (selectedCenter === "All" || d.center === selectedCenter)
                );
                return ["All", ...new Set(filtered.map(d => d.therapist))].sort();
            }, [salesData, selectedBrand, selectedCenter]);

            // Handlers to reset child-dropdowns when parent-dropdown changes
            const handleBrandChange = (e) => {
                setSelectedBrand(e.target.value);
                setSelectedCenter("All");
                setSelectedTherapist("All");
            };

            const handleCenterChange = (e) => {
                setSelectedCenter(e.target.value);
                setSelectedTherapist("All");
            };

            // --- AGGREGATION LOGIC ---
            const stats = useMemo(() => {
                // 1. Filter data based on ALL selected dropdowns
                const filtered = salesData.filter(d => 
                    (selectedBrand === "All" || d.brand === selectedBrand) &&
                    (selectedCenter === "All" || d.center === selectedCenter) &&
                    (selectedTherapist === "All" || d.therapist === selectedTherapist)
                );

                // 2. Sum the columns
                const sumTarget = filtered.reduce((sum, row) => sum + row.target, 0);
                const sumActual = filtered.reduce((sum, row) => sum + row.actual, 0);
                
                // 3. Dynamically calculate MTD% so it is accurate for groups
                const calcMtdPct = sumTarget > 0 ? (sumActual / sumTarget) * 100 : 0;

                return {
                    target: sumTarget,
                    actual: sumActual,
                    mtdPct: calcMtdPct,
                    acb: filtered.reduce((sum, row) => sum + row.acb, 0),
                    icb: filtered.reduce((sum, row) => sum + row.icb, 0),
                    acbShop: filtered.reduce((sum, row) => sum + row.acbShop, 0),
                    icbShop: filtered.reduce((sum, row) => sum + row.icbShop, 0),
                };
            }, [salesData, selectedBrand, selectedCenter, selectedTherapist]);

            // Formatters
            const formatCurrency = (val) => new Intl.NumberFormat('zh-HK', { style: 'currency', currency: 'HKD', maximumFractionDigits: 0 }).format(val);
            const formatNumber = (val) => new Intl.NumberFormat('zh-HK').format(val);
            const formatPct = (val) => `${val.toFixed(1)}%`;

            if (isLoading) {
                return <div className="min-h-screen bg-black flex items-center justify-center text-cyan-400 font-bold animate-pulse">正在載入 Google Sheet 數據... (Loading Data)</div>;
            }

            return (
                <div className="min-h-screen bg-black text-slate-200 font-sans p-4 md:p-8">
                    {/* Header */}
                    <div className="max-w-5xl mx-auto mb-10 text-center relative">
                        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl -z-10"></div>
                        <h1 className="text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2">
                            數據同步看板
                        </h1>
                        <p className="text-slate-500 text-sm tracking-widest uppercase mb-8">Live Performance Dashboard</p>
                    </div>

                    {/* Dashboard Section */}
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-slate-900/60 border border-slate-800 rounded-3xl p-8 backdrop-blur-xl">
                            
                            {/* Cascading Dropdown Filters */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 pb-8 border-b border-slate-800">
                                <div>
                                    <label className="block text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-2">品牌 (Brand)</label>
                                    <select value={selectedBrand} onChange={handleBrandChange} className="w-full bg-slate-800 border border-slate-700 rounded-lg text-white p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                        {brands.map(b => <option key={b} value={b}>{b}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-2">中心 (Center)</label>
                                    <select value={selectedCenter} onChange={handleCenterChange} className="w-full bg-slate-800 border border-slate-700 rounded-lg text-white p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                        {centers.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-2">治療師 (Therapist)</label>
                                    <select value={selectedTherapist} onChange={(e) => setSelectedTherapist(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-lg text-white p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                        {therapists.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                </div>
                            </div>

                            {/* Data Display Grid */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <DataCard title="Sales Target" value={formatCurrency(stats.target)} highlight="text-white" />
                                <DataCard title="Actual Sales (MTD)" value={formatCurrency(stats.actual)} highlight="text-green-400" />
                                <DataCard title="MTD %" value={formatPct(stats.mtdPct)} highlight={stats.mtdPct >= 100 ? "text-green-400" : "text-yellow-400"} />
                                
                                {/* Spacer for grid alignment if needed, or just let them flow */}
                                <div className="hidden lg:block"></div> 

                                <DataCard title="ACB of cur. month" value={formatNumber(stats.acb)} highlight="text-cyan-400" />
                                <DataCard title="ICB of cur. month" value={formatNumber(stats.icb)} highlight="text-purple-400" />
                                <DataCard title="ACB Shop Count" value={formatNumber(stats.acbShop)} highlight="text-blue-400" />
                                <DataCard title="ICB Shop Count" value={formatNumber(stats.icbShop)} highlight="text-indigo-400" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Reusable UI Component for the data boxes
        const DataCard = ({ title, value, highlight }) => (
            <div className="bg-slate-800/40 border border-slate-700 p-6 rounded-2xl flex flex-col justify-center hover:bg-slate-700/40 transition-colors">
                <span className="text-slate-400 text-[11px] font-bold uppercase tracking-wider mb-2">{title}</span>
                <span className={`text-3xl font-black ${highlight}`}>{value}</span>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
