<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 銷售規劃模擬器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICON COMPONENTS ---
        const User = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Database = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;

        const App = () => {
            // Data States
            const [salesData, setSalesData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedTherapist, setSelectedTherapist] = useState("All");

            // --- FETCH DATA FROM GOOGLE SHEETS ---
            useEffect(() => {
                // Your exact Google Sheet ID and GID
                const sheetId = '1p8cqGBYiqhWgQsDndMjeGwcnupqp6h6tIyCQb1i5LQc';
                const gid = '184945526';
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

                Papa.parse(csvUrl, {
                    download: true,
                    header: false, // Using arrays (indexes) is safer than relying on exact header text
                    complete: (results) => {
                        // Skip the header row (index 0)
                        const rows = results.data.slice(1);
                        
                        // Map Columns C through J
                        const parsedData = rows
                            .filter(row => row[2]) // Ensure Column C (Therapist) is not empty
                            .map(row => ({
                                therapist: row[2].trim(), // Col C
                                colD: Number(row[3]) || 0, // Col D (e.g. ACB)
                                colE: Number(row[4]) || 0, // Col E 
                                colF: Number(row[5]) || 0, // Col F 
                                colG: Number(row[6]) || 0, // Col G 
                                colH: Number(row[7]) || 0, // Col H 
                                colI: Number(row[8]) || 0, // Col I 
                                colJ: Number(row[9]) || 0, // Col J 
                            }));
                        
                        setSalesData(parsedData);
                        setIsLoading(false);
                    },
                    error: (error) => {
                        console.error("Error fetching Google Sheet:", error);
                        setIsLoading(false);
                    }
                });
            }, []);

            // --- AGGREGATION & FILTERING LOGIC ---
            // 1. Get unique therapists and sort them alphabetically
            const therapists = useMemo(() => {
                return ["All", ...new Set(salesData.map(d => d.therapist))].sort();
            }, [salesData]);

            // 2. Sum up Columns D to J based on the selected therapist
            const aggregatedStats = useMemo(() => {
                const filtered = salesData.filter(d => 
                    selectedTherapist === "All" || d.therapist === selectedTherapist
                );

                return {
                    sumD: filtered.reduce((sum, row) => sum + row.colD, 0),
                    sumE: filtered.reduce((sum, row) => sum + row.colE, 0),
                    sumF: filtered.reduce((sum, row) => sum + row.colF, 0),
                    sumG: filtered.reduce((sum, row) => sum + row.colG, 0),
                    sumH: filtered.reduce((sum, row) => sum + row.colH, 0),
                    sumI: filtered.reduce((sum, row) => sum + row.colI, 0),
                    sumJ: filtered.reduce((sum, row) => sum + row.colJ, 0),
                };
            }, [salesData, selectedTherapist]);

            if (isLoading) {
                return <div className="min-h-screen bg-black flex items-center justify-center text-cyan-400 font-bold animate-pulse">正在載入 Google Sheet 數據... (Loading Data)</div>;
            }

            return (
                <div className="min-h-screen bg-black text-slate-200 font-sans p-4 md:p-8">
                    {/* Header */}
                    <div className="max-w-4xl mx-auto mb-10 text-center relative">
                        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl -z-10"></div>
                        <h1 className="text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2">
                            數據同步看板
                        </h1>
                        <p className="text-slate-500 text-sm tracking-widest uppercase mb-8">Live Google Sheets Integration</p>
                    </div>

                    {/* Dashboard Section */}
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-slate-900/60 border border-slate-800 rounded-3xl p-8 backdrop-blur-xl relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl -z-10"></div>
                            
                            <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                                <Database className="text-purple-400" />
                                治療師表現概覽 (Therapist Performance)
                            </h2>

                            {/* Dropdown Filter */}
                            <div className="mb-8 max-w-sm">
                                <label className="block text-xs font-semibold text-cyan-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                    <User className="w-4 h-4" /> 選擇治療師 (Select Therapist)
                                </label>
                                <select 
                                    value={selectedTherapist} 
                                    onChange={(e) => setSelectedTherapist(e.target.value)} 
                                    className="w-full bg-slate-800 border border-slate-700 rounded-lg text-white p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                >
                                    {therapists.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>

                            {/* Data Display Grid for Columns D to J */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <DataCard title="Column D (ACB)" value={aggregatedStats.sumD} />
                                <DataCard title="Column E (ACB Shop)" value={aggregatedStats.sumE} />
                                <DataCard title="Column F (ICB Shop)" value={aggregatedStats.sumF} />
                                <DataCard title="Column G" value={aggregatedStats.sumG} />
                                <DataCard title="Column H" value={aggregatedStats.sumH} />
                                <DataCard title="Column I" value={aggregatedStats.sumI} />
                                <DataCard title="Column J" value={aggregatedStats.sumJ} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Reusable UI Component for the data boxes
        const DataCard = ({ title, value }) => (
            <div className="bg-slate-800/60 border border-slate-700 p-4 rounded-xl flex flex-col items-center justify-center text-center hover:bg-slate-700/60 transition-colors shadow-lg">
                <span className="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-2">{title}</span>
                <span className="text-3xl font-black text-white">{value}</span>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
